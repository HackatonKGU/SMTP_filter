# SMTP Filter System: Руководство проекта

## 1. О проекте

В рамках данного проекта мы разработали локальную систему фильтрации SMTP-трафика. Ее основная задача — обнаруживать угрозы, нежелательный и опасный контент в электронных письмах с использованием локально развернутых AI-моделей через Ollama. Мы спроектировали систему так, чтобы она была полностью автономной и не требовала доступа к внешним сетям.

## 2. Архитектура системы

Мы реализовали следующую архитектуру, где все компоненты взаимодействуют локально:

```
[Почтовый клиент] -> [SMTP Фильтр (порт 10025)] -> [Ollama AI] -> [MailHog (порт 1025)]
                                      |
                                      +-> [FastAPI (порт 8000)] <-> [База данных (SQLite)]
```
- **SMTP Фильтр** выступает в роли прокси-сервера.
- **Ollama AI** анализирует текст письма.
- **MailHog** используется как "песочница" для безопасных писем.
- **FastAPI** предоставляет веб-интерфейс и API для управления.
- **База данных** хранит информацию о заблокированных сообщениях.

## 3. Начало работы

Для работы и включения нейросетей требуется устновить gemma3:4b как основную и mistral 7b через pull
В случае 502 респонса в терминале и 404 респонса на олламе - удалить основную модель и загрузить заново (rm / pull)

Для развертывания и запуска системы нам нужно выполнить следующие шаги.

| Шаг | Команда | Описание |
|---|---|---|
| 1 | `pip install -r requirements.txt` | Установка всех необходимых зависимостей. |
| 2 | `python app.py start` | Запуск всех компонентов системы, включая SMTP-сервер, API и MailHog. |

## 4. Управление и тестирование

Мы создали единую точку входа (`app.py`) для управления системой и несколько инструментов для ее проверки.

### 4.1. Основные команды

| Команда | Описание |
|---|---|
| `python app.py start` | Запускает все сервисы. |
| `python app.py status` | Показывает текущий статус Ollama, MailHog и используемые порты. |
| `python app.py test` НЕ РАБОТАЕТ НЕ ИСПОЛЬЗОВАТЬ | Запускает быстрый интеграционный тест для проверки всей цепочки. |
| `python scripts/diagnose_ollama.py` | диагностика |

### 4.2. Пользовательские интерфейсы

Мы разработали несколько веб-интерфейсов для мониторинга:

- **Панель управления**: `http://localhost:8000/interface/`
- **Просмотр блокировок**: `http://localhost:8000/interface/blocked.html`
- **Просмотр прошедших писем**: `http://localhost:8025` (MailHog)

### 4.3. Стресс-тестирование

Для массовой проверки точности фильтра мы создали скрипт, который отправляет 30 случайных сообщений из датасета.

```bash
python scripts/send_from_dataset.py
```

## 5. Кастомизация и развитие

Мы предусмотрели возможности для гибкой настройки и дальнейшего улучшения системы.

### 5.1. Изменение AI-модели

Мы можем изменить рабочую AI-модель как через конфигурационный файл, так и через веб-интерфейс.

1.  **Убедитесь, что модель доступна**:
    ```bash
    ollama list
    ```
2.  **Способ 1 (Рекомендуемый)**: Через веб-интерфейс.
    - Откройте **Панель управления**.
    - Выберите модель из выпадающего списка и нажмите "Сменить модель".
3.  **Способ 2 (Вручную)**: Откройте `core/config.py` и измените значение переменной `OLLAMA_MODEL`.
4.  **Перезапустите систему**, чтобы изменения вступили в силу.

### 5.2. Работа с набором данных

Для улучшения качества детекции нам нужно периодически дополнять набор данных.

1.  **Добавьте примеры**: Откройте `scripts/generate_dataset.py` и добавьте текст в списки `normal_messages` или `terror_messages`.
2.  **Сгенерируйте новый датасет**:
    ```bash
    python scripts/generate_dataset.py
    ```
3.  **Протестируйте модели** на новых данных:
    ```bash
    python tests/test_models.py
    ```
    Эта команда покажет, как новая модель справляется с обновленным датасетом.

## 6. Структура проекта

Мы организовали проект по модульному принципу для упрощения навигации и поддержки.

| Путь | Описание |
|---|---|
| `app.py` | **Главный файл** для запуска и управления системой. |
| `core/` | **Ядро системы**: вся основная бизнес-логика. |
| `api/` | **FastAPI приложение**: предоставляет REST API и веб-интерфейс. |
| `web/` | **Статические файлы** веб-интерфейса (HTML, CSS). |
| `tests/` | **Скрипты для тестирования** и оценки производительности. |
| `scripts/` | **Инструменты**: генерация датасетов и отправка тестовых писем. |
| `utils/` | **Утилиты**: менеджер для управления MailHog. |
| `logs/` | Директория для хранения логов (создается при необходимости). |
| `requirements.txt` | Список зависимостей Python. |
| `README.md` | Данное руководство. |